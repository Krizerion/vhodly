name: Deploy Backend to AWS Elastic Beanstalk

on:
  push:
    branches:
      - main

env:
  AWS_REGION: eu-central-1
  ECR_REPOSITORY: vhodly-api
  EB_APPLICATION_NAME: vhodly-api-prod
  EB_ENVIRONMENT_NAME: Vhodly-api-prod-env

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push image to Amazon ECR
        working-directory: ./vhodly-api
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REPOSITORY:$IMAGE_TAG .
          docker tag $ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker tag $ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

      - name: Prepare Dockerrun file
        working-directory: ./vhodly-api
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          # Replace placeholder with actual ECR registry
          sed -i "s|YOUR_ACCOUNT_ID.dkr.ecr.eu-central-1.amazonaws.com|$ECR_REGISTRY|g" Dockerrun.aws.json
          
          # Update CORS_ORIGIN if secret is provided
          if [ -n "${{ secrets.FRONTEND_URL }}" ]; then
            # Install jq for JSON manipulation
            sudo apt-get update && sudo apt-get install -y jq
            # Add CORS_ORIGIN to environment variables using jq
            jq ".containerDefinitions[0].environment += [{\"name\": \"CORS_ORIGIN\", \"value\": \"${{ secrets.FRONTEND_URL }}\"}]" Dockerrun.aws.json > Dockerrun.aws.json.tmp && mv Dockerrun.aws.json.tmp Dockerrun.aws.json
          fi
          
          echo "üìÑ Dockerrun.aws.json contents:"
          cat Dockerrun.aws.json

      - name: Create deployment package
        working-directory: ./vhodly-api
        run: |
          zip -r deploy.zip Dockerrun.aws.json

      - name: Get or create S3 bucket for deployments
        env:
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
        run: |
          S3_BUCKET="elasticbeanstalk-${{ env.AWS_REGION }}-$AWS_ACCOUNT_ID"
          echo "S3_BUCKET=$S3_BUCKET" >> $GITHUB_ENV
          # Try to create bucket, ignore if it already exists
          aws s3 mb s3://$S3_BUCKET --region ${{ env.AWS_REGION }} 2>/dev/null || true
          echo "Using S3 bucket: $S3_BUCKET"

      - name: Upload deployment package to S3
        env:
          VERSION_LABEL: vhodly-api-${{ github.sha }}
        run: |
          aws s3 cp ./vhodly-api/deploy.zip s3://${{ env.S3_BUCKET }}/${{ env.EB_APPLICATION_NAME }}/$VERSION_LABEL.zip --region ${{ env.AWS_REGION }}
          echo "‚úÖ Deployment package uploaded to S3"

      - name: Create application version with S3 source
        env:
          VERSION_LABEL: vhodly-api-${{ github.sha }}
        run: |
          aws elasticbeanstalk create-application-version \
            --application-name ${{ env.EB_APPLICATION_NAME }} \
            --version-label $VERSION_LABEL \
            --source-bundle S3Bucket="${{ env.S3_BUCKET }}",S3Key="${{ env.EB_APPLICATION_NAME }}/$VERSION_LABEL.zip" \
            --description "Deployed from GitHub Actions - Commit ${{ github.sha }}" \
            --region ${{ env.AWS_REGION }} \
            --auto-create-application || true
          
          echo "‚úÖ Application version created: $VERSION_LABEL"

      - name: Update Elastic Beanstalk environment
        env:
          VERSION_LABEL: vhodly-api-${{ github.sha }}
        run: |
          echo "Updating Elastic Beanstalk environment..."
          aws elasticbeanstalk update-environment \
            --application-name ${{ env.EB_APPLICATION_NAME }} \
            --environment-name ${{ env.EB_ENVIRONMENT_NAME }} \
            --version-label $VERSION_LABEL \
            --region ${{ env.AWS_REGION }}
          
          echo "‚úÖ Deployment initiated"

      - name: Wait for deployment to complete
        env:
          VERSION_LABEL: vhodly-api-${{ github.sha }}
        run: |
          echo "Waiting for deployment to complete (this may take 5-10 minutes)..."
          aws elasticbeanstalk wait environment-updated \
            --application-name ${{ env.EB_APPLICATION_NAME }} \
            --environment-names ${{ env.EB_ENVIRONMENT_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --max-attempts 60 \
            --delay 10 || echo "Deployment in progress - check AWS Console for status"

      - name: Get environment URL
        run: |
          ENV_URL=$(aws elasticbeanstalk describe-environments \
            --application-name ${{ env.EB_APPLICATION_NAME }} \
            --environment-names ${{ env.EB_ENVIRONMENT_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Environments[0].CNAME' \
            --output text)
          echo "‚úÖ Deployment complete!"
          echo "üìç Environment URL: http://$ENV_URL"
          echo "üìö Swagger docs: http://$ENV_URL/api/docs"
          echo "üîí Note: Use HTTPS if SSL certificate is configured"
